<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>Peta 3D WNA Kantor Imigrasi Biak</title>
  <script src="https://cesium.com/downloads/cesiumjs/releases/1.115/Build/Cesium/Cesium.js"></script>
  <link href="https://cesium.com/downloads/cesiumjs/releases/1.115/Build/Cesium/Widgets/widgets.css" rel="stylesheet">
  <style>
    html, body, #cesiumContainer { width:100%; height:100%; margin:0; padding:0; overflow:hidden; }

    /* Panel detail kanan */
    #panelDetail {
      position:absolute; top:70px; right:20px; width:400px; max-height:80%;
      overflow-y:auto; background:rgba(0,0,0,0.85); color:#fff;
      font-family:Arial,sans-serif; padding:12px; border-radius:6px;
      display:none; z-index:2;
    }
    #panelDetail h3 { margin:8px 0; color:yellow; text-align:center; }
    #panelDetail h4 { margin:6px 0; color:cyan; text-align:center; }
    #panelDetail a { color: cyan; cursor: pointer; display: inline-block; margin: 2px 0; text-decoration: none; }
    #panelDetail a:hover { text-decoration: underline; }
    #btnBack { display:block; background:#444; color:white; text-align:center; padding:6px; margin-top:10px; border-radius:4px; cursor:pointer; }

    /* Tombol Home */
    #btnHome { position:absolute; top:10px; left:20px; background:transparent; border:none; border-radius:50%; cursor:pointer; z-index:10; padding:6px; }
    #btnHome:hover { transform:scale(1.1); }
    #btnHome img { width:32px; height:32px; filter: drop-shadow(2px 2px 5px black); }

    /* Header Tengah */
    #headerInfo { position:absolute; top:15px; left:50%; transform:translateX(-50%); text-align:center; z-index:3; font-family:Arial,sans-serif; color:white; text-shadow:1px 1px 3px black; }
    #headerInfo h2 { margin:0; font-size:20px; font-weight:bold; }
    #headerInfo p { margin:2px 0 0 0; font-size:16px; }

    /* === Modal Detail WNA (tengah layar) === */
#detailsModal {
  display: none;
  position: fixed;
  z-index: 2000;
  left: 0; top: 0;
  width: 100%; height: 100%;
  background: rgba(0,0,0,0.7);
  justify-content: center;
  align-items: center;
}
.modal-content {
  background-color: #1e1e1e;
  padding: 28px 32px;
  border-radius: 14px;
  width: 95%; max-width: 640px;
  color: #f1f1f1;
  font-family: "Segoe UI", Arial, sans-serif;
  box-shadow: 0 0 25px rgba(0,0,0,0.6);
  position: relative;
  display: flex;
  align-items: center;   /* <== tambahkan ini */
  gap: 24px;
  animation: fadeIn 0.25s ease-in-out;
}
@keyframes fadeIn {
  from { opacity: 0; transform: translateY(-20px); }
  to { opacity: 1; transform: translateY(0); }
}
.modal-left {
  flex-shrink: 0;
  text-align: center;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center; /* <== tambahkan ini agar vertikal tengah */
}
.modal-left img {
  width: 180px;
  height: 230px;
  object-fit: cover;
  border-radius: 10px;
  border: 3px solid #444;
  background: transparent;     /* hilangkan warna putih di belakang */
  box-shadow: 0 0 10px rgba(0,0,0,0.6);
  opacity: 1;
  transition: opacity 0.3s ease; /* efek halus */
}
.modal-right {
  flex: 1;
  display: flex;
  flex-direction: column;
  align-items: center; /* <-- ini kuncinya agar semua isi termasuk nama WNA di tengah */
}
#modalName {
  color: #FFD700;
  font-size: 22px;
  font-weight: 700;
  margin: 0 0 10px 0;
  text-align: center;
}
.detail-table {
  width: 100%;
  border-collapse: collapse;
  font-size: 14px;
}
.detail-table tr td:first-child {
  width: 40%;
  color: #bbb;
  text-align: right;
  padding: 4px 12px 4px 0;
  font-weight: 600;
}
.detail-table tr td:last-child {
  color: #fff;
  padding: 4px 0;
  word-break: break-word;
}
#modalCloseButton {
  position: absolute;
  right: 15px; top: 10px;
  font-size: 28px;
  cursor: pointer;
  color: #aaa;
  transition: 0.2s;
}
#modalCloseButton:hover {
  color: #fff;
  transform: scale(1.1);
}

/* Responsif (HP) */
@media (max-width: 560px) {
  .modal-content { flex-direction: column; align-items: center; padding: 20px; }
  .modal-left img { width: 140px; height: 180px; }
  #modalName { text-align: center; }
  .detail-table tr td:first-child { text-align: left; width: 45%; }
}
/* === Nama Tengah Modal === */
.nama-tengah {
  position: absolute;
  top: -15px;              /* ‚¨ÖÔ∏è ini kuncinya: geser ke bagian atas dalam kotak */
  left: 50%;
  transform: translateX(-50%);
  font-size: 24px;
  font-weight: bold;
  color: #FFD700;
  text-shadow: 2px 2px 6px rgba(0,0,0,0.7);
  pointer-events: none;
  text-align: center;
  width: 100%;
  z-index: 10;
}
  </style>
</head>
<body>
  <div id="cesiumContainer"></div>
  <div id="panelDetail"></div>

  <!-- Tombol Home -->
  <button id="btnHome" onclick="goHome()"><img src="https://img.icons8.com/ios-filled/50/ffffff/home.png" alt="Home"/></button>

  <!-- Menu Upload -->
  <div id="menuBox" style="position:absolute; top:18px; left:70px; z-index:2000;">
    <button id="btnMenu" style="background:transparent; color:white; border:none; font-size:20px; cursor:pointer; padding:4px 10px; border-radius:4px;">‚ãÆ</button>
    <div id="menuDropdown" style="display:none; position:absolute; top:30px; left:0; background:rgba(0,0,0,0.85); color:white; padding:10px; border-radius:6px; width:220px;">
      <label>üìÅ Upload Data Perusahaan
        <input type="file" id="uploadPerusahaan" accept=".json">
      </label>
      <hr style="margin:8px 0; border:0; border-top:1px solid gray;">
      <label>üë§ Upload Data WNA
        <input type="file" id="uploadWNA" accept=".json">
      </label>
    </div>
  </div>

  <!-- Header Tengah -->
  <div id="headerInfo"><h2 id="judulHeader"></h2><p id="totalWna"></p></div>

  <!-- Modal Detail WNA -->
  <!-- Modal Detail WNA -->
<div id="detailsModal" role="dialog" aria-hidden="true">
  <div class="modal-content" role="document">
    <!-- Nama di tengah -->
    <h3 id="modalNameCenter" class="nama-tengah"></h3>

    <span id="modalCloseButton" aria-label="Tutup">&times;</span>

    <div class="modal-left">
      <div class="foto-box" id="modalFotoBox"></div>
    </div>

    <div class="modal-right">
      <h3 id="modalName" style="margin-top:0; color:yellow;"></h3>
      <table class="detail-table">
        <tr><td>Jenis Izin Tinggal</td><td id="modalJenisIzin"></td></tr>
        <tr><td>Nomor Permit</td><td id="modalNomorPermit"></td></tr>
        <tr><td>Index Permit</td><td id="modalIndexPermit"></td></tr>
        <tr><td>Masa Berlaku</td><td id="modalMasaBerlaku"></td></tr>
        <tr><td>Tempat, Tgl Lahir</td><td id="modalTtl"></td></tr>
        <tr><td>No. Paspor</td><td id="modalPaspor"></td></tr>
        <tr><td>Kebangsaan</td><td id="modalKebangsaan"></td></tr>
        <tr><td>Jenis Kelamin</td><td id="modalLp"></td></tr>
        <tr><td>Alamat</td><td id="modalAlamat"></td></tr>
        <tr><td>Kabupaten</td><td id="modalKab"></td></tr>
        <tr><td>Pekerjaan</td><td id="modalPekerjaan"></td></tr>
        <tr><td>Penjamin</td><td id="modalPenjamin"></td></tr>
        <tr><td>Aktivitas</td><td id="modalAktivitas"></td></tr>
        <tr><td>Tanggal Terbit</td><td id="modalTanggalTerbit"></td></tr>
      </table>
    </div>
  </div>
</div>
  <tr><td>Jenis Izin Tinggal</td><td id="modalJenisIzin"></td></tr>
  <tr><td>Nomor Permit</td><td id="modalNomorPermit"></td></tr>
  <tr><td>Index Permit</td><td id="modalIndexPermit"></td></tr>
  <tr><td>Masa Berlaku</td><td id="modalMasaBerlaku"></td></tr>
  <tr><td>Tempat, Tgl Lahir</td><td id="modalTtl"></td></tr>
  <tr><td>No. Paspor</td><td id="modalPaspor"></td></tr>
  <tr><td>Kebangsaan</td><td id="modalKebangsaan"></td></tr>
  <tr><td>Jenis Kelamin</td><td id="modalLp"></td></tr>
  <tr><td>Alamat</td><td id="modalAlamat"></td></tr>
  <tr><td>Kabupaten</td><td id="modalKab"></td></tr>
  <tr><td>Pekerjaan</td><td id="modalPekerjaan"></td></tr>
  <tr><td>Penjamin</td><td id="modalPenjamin"></td></tr>
  <tr><td>Aktivitas</td><td id="modalAktivitas"></td></tr>
  <tr><td>Tanggal Terbit</td><td id="modalTanggalTerbit"></td></tr>
</table>
      </div>
    </div>
  </div>

<script>
/* ======================
   Data & Cesium init
   ====================== */
const data = {
  biak: { nama: "Kab. Biak Numfor", lon: 136.037, lat: -1.052, perusahaan:[] },
  nabire: { nama:"Kab. Nabire", lon:135.495, lat:-3.392, perusahaan:[] },
  yapen: { nama:"Kab. Kep. Yapen", lon:136.250, lat:-1.755, perusahaan:[] },
  waropen: { nama:"Kab. Waropen", lon:136.494, lat:-2.308, perusahaan:[] },
  supiori: { nama:"Kab. Supiori", lon:135.640, lat:-0.875, perusahaan:[] }
};

Cesium.Ion.defaultAccessToken = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJqdGkiOiIzOThjZjJmNy04NjM2LTQyNjItOGZjMi04MWZiNTAxOTAyNTMiLCJpZCI6MzQzNzA4LCJpYXQiOjE3NTg1ODMwNDd9.B64XWMMB3kxMRB6lkeHrLW8kMALnQIvDuJ9PLIqlKNQ";
const viewer = new Cesium.Viewer("cesiumContainer", {
  timeline:false, animation:false, infoBox:false, selectionIndicator:false,
  baseLayerPicker:false, geocoder:false, homeButton:false,
  navigationHelpButton:false, sceneModePicker:false, fullscreenButton:false
});

const FOTO_BASE_PATH = "./foto/";
let dataWNAUpload = null, dataPerusahaanUpload = null;

/* ======================
   Utility & header
   ====================== */
function normalizeName(s){ return (s||"").toString().toUpperCase().replace(/[^A-Z0-9]/g,""); }

function hitungTotalWNAKabupaten(key){
  let total=0;
  (data[key].perusahaan||[]).forEach(p=> total += (p.wna?.length || 0));
  return total;
}
function hitungTotalSemuaWNA(){
  let total=0;
  for(const k in data) total += hitungTotalWNAKabupaten(k);
  return total;
}
function tampilkanHeaderPapua(){
  document.getElementById("judulHeader").innerText = "DATA WNA PADA WILAYAH KERJA KANTOR IMIGRASI BIAK";
  document.getElementById("totalWna").innerText = "TOTAL: " + hitungTotalSemuaWNA() + " WNA";
  document.getElementById("headerInfo").style.display = "block";
}
function tampilkanHeaderKabupaten(key){
  document.getElementById("judulHeader").innerText = "DATA WNA DI " + data[key].nama.toUpperCase();
  document.getElementById("totalWna").innerText = "TOTAL: " + hitungTotalWNAKabupaten(key) + " WNA";
  document.getElementById("headerInfo").style.display = "block";
}
function tampilkanHeaderPerusahaan(perusahaan, kabKey){
  document.getElementById("judulHeader").innerText = perusahaan.nama.toUpperCase();
  document.getElementById("totalWna").innerText = "TOTAL: " + (perusahaan.wna?.length || 0) + " WNA";
  document.getElementById("headerInfo").style.display = "block";
}
function sembunyikanHeader(){ document.getElementById("headerInfo").style.display = "none"; }

/* ======================
   Upload handling
   ====================== */
document.getElementById("btnMenu").onclick = () => {
  const d = document.getElementById("menuDropdown");
  d.style.display = d.style.display === "block" ? "none" : "block";
};
document.getElementById("uploadPerusahaan").addEventListener("change", e=>{
  const f = e.target.files[0]; if(!f) return;
  const r = new FileReader();
  r.onload = ev => { try{ dataPerusahaanUpload = JSON.parse(ev.target.result); alert("‚úÖ Data Perusahaan berhasil dimuat!"); updateData(); tampilkanHeaderPapua(); goHome(); } catch(err){ alert("‚ùå Gagal membaca Data Perusahaan: "+err.message); } };
  r.readAsText(f);
});
document.getElementById("uploadWNA").addEventListener("change", e=>{
  const f = e.target.files[0]; if(!f) return;
  const r = new FileReader();
  r.onload = ev => { try{ dataWNAUpload = JSON.parse(ev.target.result); alert("‚úÖ Data WNA berhasil dimuat!"); updateData(); tampilkanHeaderPapua(); goHome(); } catch(err){ alert("‚ùå Gagal membaca Data WNA: "+err.message); } };
  r.readAsText(f);
});

/* ======================
   Update data merging
   ====================== */
function updateData(){
  if(!dataPerusahaanUpload && !dataWNAUpload) return;
  const mapKab = { "biak":"biak","biak numfor":"biak","yapen":"yapen","kepulauan yapen":"yapen","nabire":"nabire","waropen":"waropen","supiori":"supiori" };

  if(dataPerusahaanUpload){
    for(const key in dataPerusahaanUpload){
      const kabKey = mapKab[key.toLowerCase()];
      if(kabKey && data[kabKey]) data[kabKey].perusahaan = dataPerusahaanUpload[key].map(p => Object.assign({ wna: p.wna || [] }, p));
    }
  }

  if(dataWNAUpload){
    // reset
    for(const k in data) (data[k].perusahaan||[]).forEach(p=> p.wna = []);
    const peroranganTemp = {};
    dataWNAUpload.forEach(w=>{
      const kab = (w.kabupaten||"").toLowerCase();
      const mapped = mapKab[kab];
      if(!mapped) return;
      const normG = normalizeName(w.guarantor || "");
      const perusahaanList = data[mapped].perusahaan || [];
      const cocok = perusahaanList.find(p => normalizeName(p.nama) === normG);
      if(cocok) cocok.wna.push(w);
      else {
        const izin = (w.jenis_izin_tinggal || w.jenisIzin || "").toString().toUpperCase();
        const kategori = izin.includes("ITAP") ? "WNA PERORANGAN - ITAP" : izin.includes("ITAS") ? "WNA PERORANGAN - ITAS" : "WNA PERORANGAN - LAINNYA";
        if(!peroranganTemp[mapped]) peroranganTemp[mapped] = {};
        if(!peroranganTemp[mapped][kategori]) peroranganTemp[mapped][kategori] = [];
        peroranganTemp[mapped][kategori].push(w);
      }
    });
    for(const kabKey in peroranganTemp){
      for(const kategori in peroranganTemp[kabKey]){
        data[kabKey].perusahaan.push({ nama: kategori, lon: null, lat: null, alamat: "Dijamin Perorangan", wna: peroranganTemp[kabKey][kategori] });
      }
    }
  }
  console.log("Data updated", data);
}

/* ======================
   Entities and click handler
   ====================== */
let kabEntities = {};
for(const key in data){
  const kab = data[key];
  kabEntities[key] = viewer.entities.add({
    position: Cesium.Cartesian3.fromDegrees(kab.lon, kab.lat),
    point: { pixelSize: 10, color: Cesium.Color.CYAN },
    label: {
      text: kab.nama, font: "14pt sans-serif",
      fillColor: Cesium.Color.YELLOW, outlineColor: Cesium.Color.BLACK, outlineWidth:2,
      style: Cesium.LabelStyle.FILL_AND_OUTLINE, verticalOrigin: Cesium.VerticalOrigin.BOTTOM,
      pixelOffset: new Cesium.Cartesian2(0,-15)
    },
    properties: { type:"kabupaten", key }
  });
}

const handler = new Cesium.ScreenSpaceEventHandler(viewer.scene.canvas);
handler.setInputAction(function(click){
  const picked = viewer.scene.pick(click.position);
  if(Cesium.defined(picked) && picked.id && picked.id.properties){
    const props = picked.id.properties;
    if(props.type._value === "kabupaten") tampilkanPerusahaanKabupaten(props.key._value);
    else if(props.type._value === "perusahaan") tampilkanDetailPerusahaan(props.data._value, props.kab._value);
  }
}, Cesium.ScreenSpaceEventType.LEFT_CLICK);

/* ======================
   Panel show helper
   ====================== */
function showPanel(html, backFunc){
  const panel = document.getElementById("panelDetail");
  panel.innerHTML = html + `<div id="btnBack">Kembali</div>`;
  panel.style.display = "block";
  document.getElementById("btnBack").onclick = backFunc;
  sembunyikanHeader();
}

/* Delegated clicks inside panelDetail */
document.getElementById("panelDetail").addEventListener("click", function(e){
  if(e.target.classList.contains("perusahaan-link")){
    e.preventDefault();
    const kabKey = e.target.dataset.kab;
    const idx = parseInt(e.target.dataset.idx);
    const perusahaan = data[kabKey].perusahaan[idx];
    if(perusahaan) tampilkanDetailPerusahaan(perusahaan, kabKey);
    return;
  }
  if(e.target.classList.contains("wna-link")){
    e.preventDefault();
    const kabKey = e.target.dataset.kab;
    const perusahaanIdx = parseInt(e.target.dataset.perusahaanIdx);
    const idx = parseInt(e.target.dataset.idx);
    const perusahaan = data[kabKey].perusahaan[perusahaanIdx];
    if(perusahaan && perusahaan.wna && perusahaan.wna[idx]) tampilkanDetailWNA(perusahaan.wna[idx], perusahaan, kabKey);
    return;
  }
});

/* ======================
   Menampilkan Perusahaan per Kabupaten
   ====================== */
function tampilkanPerusahaanKabupaten(key){
  const kab = data[key];
  for(const k in kabEntities) kabEntities[k].show = false;
  // remove perusahaan entities if exist
  viewer.entities.values.filter(e => e.properties && e.properties.type && e.properties.type._value === "perusahaan").forEach(e => viewer.entities.remove(e));
  viewer.camera.flyTo({ destination: Cesium.Cartesian3.fromDegrees(kab.lon, kab.lat, 80000.0) });
  const perusahaanDenganWna = (kab.perusahaan || []).filter(p => p.wna && p.wna.length > 0);
const listHtml = perusahaanDenganWna.map((p, idx) => `
  <li style="margin-bottom:6px;">
    <span style="
      background:#ffcc00;
      color:black;
      padding:2px 8px;
      border-radius:8px;
      margin-right:6px;
      font-weight:bold;">
      ${idx + 1}
    </span>
    <a href="#" class="perusahaan-link" data-kab="${key}" data-idx="${(kab.perusahaan || []).indexOf(p)}">
      ${p.nama}
    </a>
    <span style="color:#aaa; font-size:13px;"> (${p.wna.length} WNA)</span>
  </li>
`).join("");
  const html = `<h3>${kab.nama}</h3><h4>Daftar Perusahaan (yang memiliki WNA)</h4><ul style="list-style:none; padding:0;">${listHtml || "<p style='color:gray;'>Tidak ada perusahaan dengan WNA di kabupaten ini.</p>"}</ul>`;
  showPanel(html, () => goHome());
  tampilkanHeaderKabupaten(key);

  // add perusahaan markers (optional) for those with coords
  (kab.perusahaan || []).forEach((p, idx) => {
    if(p.wna && p.wna.length>0 && p.lon && p.lat){
      viewer.entities.add({
        position: Cesium.Cartesian3.fromDegrees(p.lon, p.lat),
        point: { pixelSize: 12, color: Cesium.Color.RED },
        label: { text: p.nama, font:"12pt sans-serif", fillColor:Cesium.Color.WHITE, outlineColor:Cesium.Color.BLACK, outlineWidth:2, verticalOrigin: Cesium.VerticalOrigin.BOTTOM, pixelOffset: new Cesium.Cartesian2(0,-10) },
        properties: { type: "perusahaan", data: p, kab: key, idx }
      });
    }
  });
}

   /* ======================
   Detail Perusahaan -> daftar WNA
   ====================== */
function tampilkanDetailPerusahaan(perusahaan, kabKey){
  const perusahaanIndex = (data[kabKey].perusahaan || []).indexOf(perusahaan);

  // jika perusahaan punya koordinat, arahkan kamera ke sana
  if(perusahaan.lon && perusahaan.lat){
    viewer.camera.flyTo({
      destination: Cesium.Cartesian3.fromDegrees(perusahaan.lon, perusahaan.lat, 5000.0)
    });
  }

  // daftar WNA
  let wnaListHtml = "";
  if(perusahaan.wna && perusahaan.wna.length > 0){
    wnaListHtml = perusahaan.wna.map((w, i) => `
      <li style="margin-bottom:6px;">
        <span style="
          background:#ffcc00;
          color:black;
          padding:2px 8px;
          border-radius:8px;
          margin-right:6px;
          font-weight:bold;">
          ${i+1}
        </span>
        <a href="#" class="wna-link"
           data-kab="${kabKey}"
           data-perusahaan-idx="${perusahaanIndex}"
           data-idx="${i}">
           ${w.nama}
        </a>
      </li>
    `).join("");
  } else {
    wnaListHtml = "<p style='color:gray;'>Tidak ada data WNA.</p>";
  }

  // tampilkan nama perusahaan + alamat di tengah
  const html = `
    <h3 style="text-align:center;">${perusahaan.nama}</h3>
    <div style="text-align:center; color:#ccc; font-size:13px; margin-bottom:10px;">
      ${perusahaan.alamat || 'Alamat tidak tersedia'}
    </div>
    <h4>Daftar WNA di Perusahaan Ini</h4>
    <ul style="list-style:none; padding:0;">${wnaListHtml}</ul>
  `;

  showPanel(html, () => tampilkanPerusahaanKabupaten(kabKey));
  tampilkanHeaderPerusahaan(perusahaan, kabKey);
}

/* ======================
   Detail WNA -> tampil modal tengah (dengan foto bila ada)
   ====================== */
function tampilkanDetailWNA(w, perusahaan, kabKey){
  const modal = document.getElementById("detailsModal");
  // prepare photo src
  const fotoName = w.foto ? w.foto.toString().trim() : "";
  let fotoSrc = "";
  if (fotoName) {
  if (/^https?:\/\//i.test(fotoName) || /^data:/i.test(fotoName)) {
    fotoSrc = fotoName;
  } else {
    fotoSrc = FOTO_BASE_PATH + fotoName;
  }
}

  // map fields with fallbacks
  const nama = w.nama || w.name || "-";
  const jenisIzin = w.jenis_izin_tinggal || w.jenisIzin || w.jenisIzinTinggal || "-";
  const permitNumber = w.permit_number || w.permitNumber || w.permit || "-";
  const permitIndex = w.stay_permit_index || w.permit_index || "-";
  const permitExpiry = w.stay_permit_expiry || w.masaBerlaku || w.expiry || "-";
  const placeOfBirth = w.place_of_birth || w.tempat_lahir || w.tempatLahir || "-";
  const dateOfBirth = w.date_of_birth || w.tanggal_lahir || w.tanggalLahir || w.tglLahir || "-";
  const passportNumber = w.passport_number || w.paspor || w.passport || "-";
  const nationality = w.nationality || w.kebangsaan || "-";
  const gender = w.gender || w.lp || w.jenis_kelamin || "-";
  const address = w.address || w.alamat || "-";
  const kabupaten = w.kabupaten || kabKey || "-";
  const occupation = w.occupation || w.pekerjaan || w.keterangan || "-";
  const guarantor = w.guarantor || "-";
  const activity = w.activity || "-";
  const tanggalTerbit = w.tanggal_terbit || w.tanggalTerbit || "-";

  // fill modal fields
  document.getElementById("modalNameCenter").textContent = nama;
  document.getElementById("modalJenisIzin").textContent = jenisIzin;
  document.getElementById("modalNomorPermit").textContent = permitNumber;
  document.getElementById("modalIndexPermit").textContent = permitIndex;
  document.getElementById("modalMasaBerlaku").textContent = permitExpiry;
  document.getElementById("modalTtl").textContent = `${placeOfBirth}, ${dateOfBirth}`;
  document.getElementById("modalPaspor").textContent = passportNumber;
  document.getElementById("modalKebangsaan").textContent = nationality;
  document.getElementById("modalLp").textContent = gender;
  document.getElementById("modalAlamat").textContent = address;
  document.getElementById("modalKab").textContent = kabupaten;
  document.getElementById("modalPekerjaan").textContent = occupation;
  document.getElementById("modalPenjamin").textContent = guarantor;
  document.getElementById("modalAktivitas").textContent = activity;
  document.getElementById("modalTanggalTerbit").textContent = tanggalTerbit;

  // foto
  const fotoBox = document.getElementById("modalFotoBox");
  fotoBox.innerHTML = "";
  if(fotoSrc){
    const img = document.createElement("img");
    img.src = fotoSrc;
    img.alt = "Foto " + nama;
    img.onerror = () => { img.style.display = "none"; };
    fotoBox.appendChild(img);
  } else {
    fotoBox.innerHTML = `<div style="color:#ccc; font-size:14px; text-align:center; padding:8px;">Tidak ada foto</div>`;
  }

  // show modal
  modal.style.display = "flex";
  modal.setAttribute("aria-hidden","false");
}

/* ======================
   Modal close handlers
   ====================== */
document.getElementById("modalCloseButton").onclick = () => {
  const modal = document.getElementById("detailsModal");
  modal.style.display = "none";
  modal.setAttribute("aria-hidden","true");
};
window.addEventListener("click", (e) => {
  const modal = document.getElementById("detailsModal");
  if(e.target === modal){ modal.style.display = "none"; modal.setAttribute("aria-hidden","true"); }
});

/* ======================
   Home / reset
   ====================== */
function goHome(){
  // remove perusahaan markers
  viewer.entities.values.filter(e => e.properties && e.properties.type && e.properties.type._value === "perusahaan").forEach(e => viewer.entities.remove(e));
  for(const k in kabEntities) kabEntities[k].show = true;
  document.getElementById("panelDetail").style.display = "none";
  tampilkanHeaderPapua();
  viewer.camera.flyTo({ destination: Cesium.Cartesian3.fromDegrees(136.0, -2.0, 1000000.0) });
}
// initial state
tampilkanHeaderPapua();
goHome();

</script>
</body>
</html>
